<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private Chat Room âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
<style>
:root {
  --day-bg: url('https://ik.imagekit.io/mrg7wer1a/a0064ace5b8acab961e5f6fc4ec005eb.jpg?updatedAt=1754334087427');
  --night-bg: url('https://ik.imagekit.io/mrg7wer1a/d51cb81754b0f48eee0866b8e9662ac5.jpg?updatedAt=1754334077449');
  --glass: rgba(255, 255, 255, 0.12);
  --glass-border: rgba(255, 255, 255, 0.18);
  --text-color: #fff;
  --input-bg: rgba(255, 255, 255, 0.15);
  --button-bg: #6366f1;
  --button-hover: #8b5cf6;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --danger-color: #ef4444;
  --muted-color: #6b7280;
  --shadow-light: 0 8px 32px rgba(31, 38, 135, 0.15);
  --shadow-medium: 0 12px 40px rgba(31, 38, 135, 0.25);
  --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.4);
}

* {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: 'Inter', sans-serif;
  background: var(--day-bg) center/cover no-repeat fixed;
  color: var(--text-color);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  overflow-x: hidden;
  transition: background 0.8s ease;
  user-select: none;
}

html.dark-mode, body.dark-mode {
  background: var(--night-bg) center/cover no-repeat fixed !important;
}

.chat-container {
  backdrop-filter: blur(25px);
  background: linear-gradient(135deg, var(--glass), rgba(255, 255, 255, 0.08));
  border: 1px solid var(--glass-border);
  border-radius: 28px;
  box-shadow: var(--shadow-heavy), inset 0 1px 0 rgba(255, 255, 255, 0.1);
  width: 100%;
  max-width: 500px;
  margin: 20px;
  padding: 2.5rem;
  text-align: center;
  position: relative;
  overflow: hidden;
}

body.dark-mode .chat-container,
html.dark-mode .chat-container {
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2));
  border: 1px solid rgba(255, 255, 255, 0.08);
}

.chat-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  position: relative;
}

.top-bar::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--button-bg), transparent);
  border-radius: 2px;
}

.top-bar h2 {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  font-size: 1.3rem;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  background: linear-gradient(135deg, #fff, #e0e7ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.theme-toggle {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 50%;
  width: 48px;
  height: 48px;
  font-size: 1.2rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-color);
  box-shadow: var(--shadow-light);
}

.theme-toggle:hover {
  transform: scale(1.1);
  background: rgba(255, 255, 255, 0.15);
  box-shadow: 0 0 25px rgba(99, 102, 241, 0.3);
}

.theme-toggle:active {
  transform: scale(0.95);
}

.online-info {
  margin-bottom: 2rem;
  padding: 1.25rem;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.08));
  backdrop-filter: blur(10px);
  border-radius: 18px;
  border: 1px solid rgba(16, 185, 129, 0.2);
  border-left: 4px solid var(--success-color);
  box-shadow: var(--shadow-light);
}

.online-info strong {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 1rem;
  margin-bottom: 0.75rem;
  font-weight: 600;
}

.online-indicator {
  width: 10px;
  height: 10px;
  background: var(--success-color);
  border-radius: 50%;
  animation: pulse 2s infinite;
  box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.2); }
}

details {
  margin-top: 10px;
}

summary {
  cursor: pointer;
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s ease;
  outline: none;
  padding: 8px;
  border-radius: 8px;
}

summary:hover {
  color: var(--button-bg);
  background: rgba(99, 102, 241, 0.1);
}

summary::marker {
  content: "";
}

#userList {
  margin-top: 12px;
  list-style: none;
  padding: 0;
}

#userList li {
  padding: 10px 16px;
  margin: 6px 0;
  background: rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(5px);
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center;
  font-size: 0.9rem;
  border: 1px solid rgba(255, 255, 255, 0.08);
  transition: all 0.2s ease;
}

#userList li:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-1px);
}

#userList li.current-user {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1));
  border: 1px solid rgba(99, 102, 241, 0.3);
  font-weight: 600;
}

#messages {
  height: 320px;
  overflow-y: auto;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 18px;
  padding: 1.25rem;
  margin-bottom: 1.25rem;
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.1));
  backdrop-filter: blur(10px);
  scrollbar-width: thin;
  scrollbar-color: var(--button-bg) transparent;
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
}

#messages::-webkit-scrollbar {
  width: 8px;
}

#messages::-webkit-scrollbar-track {
  background: transparent;
}

#messages::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, var(--button-bg), var(--button-hover));
  border-radius: 4px;
}

.msg {
  text-align: left;
  margin: 0.75rem 0;
  padding: 1rem;
  border-radius: 16px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
  backdrop-filter: blur(5px);
  border: 1px solid rgba(255, 255, 255, 0.08);
  transition: all 0.3s ease;
  box-shadow: var(--shadow-light);
}

.msg:hover {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
  transform: translateY(-1px);
  box-shadow: var(--shadow-medium);
}

.msg.own-message {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1));
  border: 1px solid rgba(99, 102, 241, 0.2);
  margin-left: auto;
  margin-right: 0;
  max-width: 85%;
}

.system-msg {
  text-align: center;
  font-style: italic;
  color: rgba(255, 255, 255, 0.7);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03)) !important;
  padding: 12px 16px;
  border-radius: 12px;
  margin: 10px auto;
  font-size: 0.9rem;
  border: 1px solid rgba(255, 255, 255, 0.05);
  max-width: 80%;
}

.download-overlay {
  position: relative;
  display: inline-block;
}

.download-btn {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  padding: 8px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  backdrop-filter: blur(5px);
  transition: all 0.2s ease;
  opacity: 0;
  transform: scale(0.8);
}

.download-overlay:hover .download-btn {
  opacity: 1;
  transform: scale(1);
}

.download-btn:hover {
  background: rgba(0, 0, 0, 0.9);
}

#typing {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.8);
  height: 1.5rem;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.typing-indicator {
  display: inline-flex;
  gap: 4px;
  align-items: center;
}

.typing-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--button-bg);
  animation: typingBounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0.32s; }

@keyframes typingBounce {
  0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
  40% { transform: scale(1.2); opacity: 1; }
}

.input-container {
  position: relative;
  margin-bottom: 1.5rem;
}

.input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

#messageInput {
  width: 100%;
  padding: 1rem 4rem 1rem 1.25rem;
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 18px;
  font-size: 1rem;
  background: linear-gradient(135deg, var(--input-bg), rgba(255, 255, 255, 0.08));
  backdrop-filter: blur(10px);
  color: white;
  outline: none;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-light);
}

#messageInput:focus {
  border-color: var(--button-bg);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15), var(--shadow-medium);
}

#messageInput::placeholder {
  color: rgba(255, 255, 255, 0.6);
}

.send-button {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(135deg, var(--button-bg), var(--button-hover));
  border: none;
  border-radius: 14px;
  width: 44px;
  height: 44px;
  cursor: pointer;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  font-size: 1rem;
  box-shadow: var(--shadow-light);
}

.send-button:hover {
  transform: translateY(-50%) scale(1.05);
  box-shadow: var(--shadow-medium);
}

.send-button:active {
  transform: translateY(-50%) scale(0.95);
}

.action-row {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 1.5rem;
}

.btn {
  padding: 12px 16px;
  background: var(--button-bg);
  border: none;
  border-radius: 16px;
  cursor: pointer;
  color: white;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 52px;
  height: 52px;
  font-size: 1.1rem;
  box-shadow: var(--shadow-light);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

.btn:active {
  transform: translateY(0);
}

.btn-success { 
  background: linear-gradient(135deg, var(--success-color), #059669); 
}
.btn-danger { 
  background: linear-gradient(135deg, var(--danger-color), #dc2626); 
}
.btn-muted { 
  background: linear-gradient(135deg, var(--muted-color), #4b5563); 
}

.btn-glass {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(59, 130, 246, 0.1));
  border: 1px solid rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  color: #fff;
  box-shadow: var(--shadow-light);
}

.btn-accent {
  background: linear-gradient(135deg, #60a5fa, #a78bfa);
  color: #fff;
  box-shadow: 0 8px 32px rgba(167, 139, 250, 0.15);
}

.btn-primary {
  background: linear-gradient(135deg, #7c3aed, #4f46e5);
  color: #fff;
  box-shadow: 0 8px 32px rgba(79, 70, 229, 0.18);
}

.btn-destructive {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: #fff;
  box-shadow: 0 8px 32px rgba(239, 68, 68, 0.15);
}

.btn-icon-sm {
  width: 44px;
  height: 44px;
  padding: 0;
  border-radius: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.call-controls {
  display: none;
  justify-content: center;
  gap: 12px;
  margin: 1.5rem 0;
  padding: 12px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-light);
}

.progress-container {
  display: none;
  margin: 1.5rem 0;
  text-align: center;
}

.progress-wrapper {
  display: flex;
  justify-content: center;
  margin: 1.5rem 0;
}

.circular-progress {
  position: relative;
  width: 120px;
  height: 120px;
}

.circular-progress svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.circular-progress .bg-circle {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.circular-progress .progress-circle {
  fill: none;
  stroke: var(--button-bg);
  stroke-width: 8;
  stroke-linecap: round;
  stroke-dasharray: 283;
  stroke-dashoffset: 283;
  transition: stroke-dashoffset 0.3s ease;
  filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.3));
}

.circular-progress .progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.1rem;
  font-weight: 600;
  color: white;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.file-info {
  background: linear-gradient(135deg, var(--input-bg), rgba(255, 255, 255, 0.08));
  backdrop-filter: blur(10px);
  padding: 1.25rem;
  border-radius: 16px;
  margin-bottom: 1.25rem;
  display: flex;
  align-items: center;
  gap: 15px;
  justify-content: center;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: var(--shadow-light);
}

.file-info i {
  font-size: 1.8rem;
  color: var(--button-bg);
  filter: drop-shadow(0 2px 4px rgba(99, 102, 241, 0.3));
}

.file-details {
  text-align: center;
}

.file-name {
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 0.95rem;
}

.file-size {
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.7);
}

#videoArea {
  display: none;
  position: relative;
  margin: 1.5rem 0;
  border-radius: 18px;
  overflow: hidden;
  box-shadow: var(--shadow-heavy);
}

#remoteVideo {
  width: 100%;
  border-radius: 18px;
}

#localVideo {
  width: 100px;
  height: 75px;
  position: absolute;
  bottom: 15px;
  right: 15px;
  border-radius: 10px;
  border: 2px solid white;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
}

.incoming-call {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 2rem;
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.7));
  border-radius: 24px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  box-shadow: var(--shadow-heavy);
  z-index: 999;
  text-align: center;
  min-width: 300px;
}

#callerInfo {
  margin-bottom: 1.5rem;
  font-weight: 600;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: center;
}

.incoming-call-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.shared-link {
  user-select: text !important;
  color: #60a5fa;
  word-break: break-word;
  cursor: pointer;
  text-decoration: none;
  transition: color 0.2s ease;
}

.shared-link:hover {
  text-decoration: underline;
  color: #93c5fd;
}

#file {
  display: none;
}

/* Responsive Design */
@media (max-width: 640px) {
  .chat-container {
    margin: 15px;
    padding: 2rem;
  }
  
  #messages {
    height: 280px;
  }
  
  .circular-progress {
    width: 100px;
    height: 100px;
  }
  
  #localVideo {
    width: 80px;
    height: 60px;
  }
  
  .top-bar h2 {
    font-size: 1.1rem;
  }
  
  .btn {
    min-width: 48px;
    height: 48px;
  }
}
</style>
  
</head>
<body>
  <div class="chat-container">
    <div class="top-bar">
      <h2>
        <i class="fas fa-comments"></i>
        ðŸŒ¸ Welcome to My Private Chat
      </h2>
      <button class="theme-toggle" onclick="toggleTheme()" id="theme-icon">
        <i class="fas fa-moon"></i>
      </button>
    </div>
    
    <div class="online-info" id="onlineInfo">
      <strong>
        <div class="online-indicator"></div>
        Online: <span id="onlineCount">0</span>
      </strong>
      <details>
        <summary>
          <i class="fas fa-users"></i>
          Show Online Users
        </summary>
        <ul id="userList"></ul>
      </details>
    </div>

    <div id="messages"></div>
    
    <div id="typing"></div>
    
    <div class="input-container">
      <div class="input-wrapper">
        <input type="text" id="messageInput" placeholder="Type your message..." oninput="notifyTyping()" />
        <button class="send-button" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <div class="action-row">
      <button id="voiceCallBtn" class="btn btn-accent" title="Voice Call">
        <i class="fas fa-phone"></i>
      </button>
      <button id="videoCallBtn" class="btn btn-accent" title="Video Call">
        <i class="fas fa-video"></i>
      </button>
      <label for="file" class="btn btn-glass" title="Attach File">
        <i class="fas fa-paperclip"></i>
      </label>
      <input type="file" id="file" onchange="sendFile()" />
    </div>

    <div class="call-controls" id="callControls">
      <button id="muteBtn" class="btn btn-glass btn-icon-sm" title="Mute/Unmute">
        <i id="micIcon" class="fas fa-microphone"></i>
      </button>
      <button id="cameraBtn" class="btn btn-glass btn-icon-sm" title="Toggle Camera" style="display: none;">
        <i id="camIcon" class="fas fa-video"></i>
      </button>
      <button id="endCallBtn" class="btn btn-destructive btn-icon-sm" title="End Call">
        <i class="fas fa-phone-slash"></i>
      </button>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="file-info" id="fileInfo" style="display: none;">
        <i class="fas fa-file"></i>
        <div class="file-details">
          <div class="file-name" id="fileName">File Name</div>
          <div class="file-size" id="fileSize">0 KB</div>
        </div>
      </div>
      
      <div class="progress-wrapper">
        <div class="circular-progress">
          <svg viewBox="0 0 100 100">
            <circle class="bg-circle" cx="50" cy="50" r="45"></circle>
            <circle class="progress-circle" cx="50" cy="50" r="45" id="progressCircle"></circle>
          </svg>
          <div class="progress-text" id="progressText">0%</div>
        </div>
      </div>
      
      <button class="btn btn-danger" onclick="cancelUpload()" id="cancelUploadBtn">
        <i class="fas fa-times"></i>
        Cancel Upload
      </button>
    </div>

    <div id="videoArea">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" muted autoplay playsinline></video>
    </div>

    <div id="incomingCall" class="incoming-call" style="display:none;">
      <p id="callerInfo">
        <i class="fas fa-phone-alt"></i>
        Incoming Call...
      </p>
      <div class="incoming-call-buttons">
        <button id="acceptCallBtn" class="btn btn-primary" title="Accept Call">
          <i class="fas fa-phone"></i>
        </button>
        <button id="rejectCallBtn" class="btn btn-destructive" title="Reject Call">
          <i class="fas fa-phone-slash"></i>
        </button>
      </div>
    </div>
  </div>

<script>
const socket = io();
let username = localStorage.getItem("chat_username");
let room = localStorage.getItem("chat_room") || "default";

// Generate username if not exists
if (!username) {
  username = "User_" + Math.random().toString(36).substr(2, 6);
  localStorage.setItem("chat_username", username);
}

const messages = document.getElementById("messages");
const typingStatus = document.getElementById("typing");

// WebRTC variables
let localStream, remoteStream, peerConnection;
const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
let isVideoCall = false;
let isMuted = false;
let isCamOn = true;

// DOM elements
const voiceCallBtn = document.getElementById("voiceCallBtn");
const videoCallBtn = document.getElementById("videoCallBtn");
const endCallBtn = document.getElementById("endCallBtn");
const callControls = document.getElementById("callControls");
const videoArea = document.getElementById("videoArea");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const muteBtn = document.getElementById("muteBtn");
const cameraBtn = document.getElementById("cameraBtn");
const incomingCall = document.getElementById("incomingCall");
const acceptCallBtn = document.getElementById("acceptCallBtn");
const rejectCallBtn = document.getElementById("rejectCallBtn");
const themeToggleBtn = document.getElementById("theme-icon");
const messageInput = document.getElementById("messageInput");
const sendButton = document.querySelector(".send-button");

// Join the room with proper username
socket.emit("join", { username, room });

// Update online user list and count
socket.on("update_user_list", (data) => {
  const userList = document.getElementById("userList");
  const onlineCount = document.getElementById("onlineCount");

  userList.innerHTML = "";
  
  data.users.forEach(user => {
    const li = document.createElement("li");
    if (user === username) {
      li.innerHTML = `<i class="fas fa-user"></i> You`;
      li.classList.add("current-user");
    } else {
      li.innerHTML = `<i class="fas fa-user"></i> ${user}`;
    }
    userList.appendChild(li);
  });
  onlineCount.textContent = data.count;
});

// Leave room on close
window.addEventListener("beforeunload", () => {
  socket.emit("leave", { username, room });
});

// Handle incoming messages
socket.on("message", data => {
  const div = document.createElement("div");
  const sender = (data.username === username && data.username !== "System") ? "You" : data.username;
  div.className = "msg";
  if (data.username === username && data.username !== "System") {
    div.classList.add("own-message");
  }

  let formattedMessage = data.message;
  // File, media, and link detection
  if (typeof formattedMessage === "string") {
    if (formattedMessage.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i)) {
      formattedMessage = `
        <div class="download-overlay">
          <img src="${formattedMessage}" alt="Image" style="max-width: 100%; border-radius: 12px; margin-top: 8px;">
          <button class="download-btn" onclick="downloadFile('${formattedMessage}', '${formattedMessage.split('/').pop()}')">
            <i class="fas fa-download"></i>
          </button>
        </div>
      `;
    } else if (formattedMessage.match(/\.(mp3|wav|ogg|m4a)$/i)) {
      formattedMessage = `<audio controls style="width: 100%; margin-top: 8px;"><source src="${formattedMessage}"></audio>`;
    } else if (formattedMessage.match(/\.(mp4|webm|mov)$/i)) {
      formattedMessage = `<video controls style="width: 100%; border-radius: 8px; margin-top: 8px;"><source src="${formattedMessage}"></video>`;
    } else if (formattedMessage.startsWith("http")) {
      const fileName = formattedMessage.split("/").pop();
      formattedMessage = `<a href="${formattedMessage}" target="_blank" class="shared-link"><i class="fas fa-external-link-alt"></i> ${fileName}</a>`;
    }
    // Convert text URLs to clickable links
    formattedMessage = formattedMessage.replace(/(https?:\/\/[^\s]+)/g, (url) => {
      if (url.includes('<a ')) return url;
      return `<a href="${url}" target="_blank" class="shared-link"><i class="fas fa-external-link-alt"></i> ${url}</a>`;
    });
  }

  if (data.username === "System") {
    div.className = "msg system-msg";
    div.innerHTML = formattedMessage;
  } else {
    div.innerHTML = `
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
        <strong style="font-weight: 600;">${sender}</strong>
        <span style="font-size: 0.75rem; color: #a0a0a0;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
      </div>
      <div style="margin-left: 4px;">${formattedMessage}</div>
    `;
  }

  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
});

// Download file function
function downloadFile(url, filename) {
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Receive file inside bubble - FIXED: Proper file handling
socket.on("file", ({ username: fromUser, fileName, data }) => {
  if (!fromUser || !fileName || !data) return;

  const div = document.createElement("div");
  div.className = "msg";
  
  const sender = fromUser === username ? "You" : fromUser;
  
  if (fromUser === username) {
    div.classList.add("own-message");
  }

  div.innerHTML = `
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
      <strong style="font-weight: 600;">${sender}</strong>
      <span style="font-size: 0.75rem; color: #a0a0a0;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
    </div>
    <div style="margin-left: 4px;">
      <a href="${data}" download="${fileName}" class="shared-link">
        <i class="fas fa-file-download"></i> ${fileName}
      </a>
    </div>
  `;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
});

// Notify typing
function notifyTyping() {
  socket.emit("typing", { username, room });
}

// Show typing status
socket.on("typing", (data) => {
  if (data.username !== username) {
    typingStatus.innerHTML = `
      <i class="fas fa-user"></i>
      ${data.username} is typing
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    clearTimeout(window.typingTimeout);
    window.typingTimeout = setTimeout(() => {
      typingStatus.textContent = "";
    }, 2000);
  }
});

// Send a message
function sendMessage() {
  const msg = messageInput.value.trim();
  if (!msg) return;
  socket.emit("message", { username, room, message: msg });
  messageInput.value = "";
  typingStatus.textContent = "";
}

// Enter key to send message
messageInput.addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    sendMessage();
  }
});

// Toggle day/night mode
function toggleTheme(){
  document.body.classList.toggle("dark-mode");
  document.documentElement.classList.toggle("dark-mode");
  const isDark = document.body.classList.contains("dark-mode");
  themeToggleBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
}

// File upload functionality
let currentUpload = null;

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIcon(fileName) {
  const ext = fileName.split('.').pop().toLowerCase();
  const iconMap = {
    pdf: 'fa-file-pdf', doc: 'fa-file-word', docx: 'fa-file-word',
    xls: 'fa-file-excel', xlsx: 'fa-file-excel',
    ppt: 'fa-file-powerpoint', pptx: 'fa-file-powerpoint',
    zip: 'fa-file-archive', rar: 'fa-file-archive', '7z': 'fa-file-archive',
    jpg: 'fa-file-image', jpeg: 'fa-file-image', png: 'fa-file-image', gif: 'fa-file-image', webp: 'fa-file-image',
    mp3: 'fa-file-audio', wav: 'fa-file-audio', ogg: 'fa-file-audio', m4a: 'fa-file-audio',
    mp4: 'fa-file-video', webm: 'fa-file-video', mov: 'fa-file-video', avi: 'fa-file-video',
    txt: 'fa-file-alt', md: 'fa-file-alt',
    js: 'fa-file-code', html: 'fa-file-code', css: 'fa-file-code', json: 'fa-file-code', xml: 'fa-file-code'
  };
  return iconMap[ext] || 'fa-file';
}

function sendFile() {
  const fileInput = document.getElementById("file");
  const file = fileInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  const progressContainer = document.getElementById("progressContainer");
  const progressCircle = document.getElementById("progressCircle");
  const progressText = document.getElementById("progressText");
  const fileInfo = document.getElementById("fileInfo");
  const fileName = document.getElementById("fileName");
  const fileSize = document.getElementById("fileSize");
  const fileIcon = fileInfo.querySelector("i");

  // Show file info
  fileName.textContent = file.name;
  fileSize.textContent = formatFileSize(file.size);
  fileIcon.className = `fas ${getFileIcon(file.name)}`;
  fileInfo.style.display = "flex";
  
  progressContainer.style.display = "block";
  progressText.textContent = "0%";
  progressCircle.style.strokeDashoffset = "283";

  const xhr = new XMLHttpRequest();
  currentUpload = xhr;

  xhr.upload.onprogress = function (e) {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      const circumference = 2 * Math.PI * 45;
      const offset = circumference - (circumference * percent / 100);
      progressCircle.style.strokeDashoffset = offset;
      progressText.textContent = `${percent}%`;
    }
  };

  xhr.onload = function () {
    if (xhr.status === 200) {
      const response = JSON.parse(xhr.responseText);
      if (response.url) {
        socket.emit("message", {
          username,
          room,
          message: response.url
        });
      }
      progressText.innerHTML = '<i class="fas fa-check" style="color: #10b981;"></i>';
    } else {
      progressText.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>';
      console.error("Upload failed:", xhr.responseText);
    }

    setTimeout(() => {
      progressContainer.style.display = "none";
      fileInfo.style.display = "none";
      progressCircle.style.strokeDashoffset = "283";
    }, 1500);
    currentUpload = null;
    fileInput.value = "";
  };

  xhr.onerror = function () {
    progressText.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>';
    setTimeout(() => {
      progressContainer.style.display = "none";
      fileInfo.style.display = "none";
      progressCircle.style.strokeDashoffset = "283";
    }, 1500);
    currentUpload = null;
    fileInput.value = "";
  };

  xhr.open("POST", "/upload", true);
  xhr.send(formData);
}

function cancelUpload() {
  if (currentUpload) {
    currentUpload.abort();
    currentUpload = null;
    document.getElementById("progressContainer").style.display = "none";
    document.getElementById("fileInfo").style.display = "none";
    document.getElementById("file").value = "";
  }
}

// WebRTC functionality
function startCall(video) {
  isVideoCall = video;
  
  videoArea.style.display = video ? "block" : "none";
  callControls.style.display = "flex";
  cameraBtn.style.display = video ? "flex" : "none";
  voiceCallBtn.disabled = true;
  videoCallBtn.disabled = true;

  navigator.mediaDevices.getUserMedia({ audio: true, video: video }).then(stream => {
    localStream = stream;
    if (video) {
      localVideo.srcObject = stream;
    }

    peerConnection = new RTCPeerConnection(config);
    peerConnection.onicecandidate = e => {
      if (e.candidate) socket.emit("ice-candidate", { candidate: e.candidate, room });
    };
    peerConnection.ontrack = e => {
      remoteVideo.srcObject = e.streams[0];
    };
    stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
    peerConnection.createOffer().then(offer => {
      peerConnection.setLocalDescription(offer);
      socket.emit("offer", { offer, username, room, video });
    });
  }).catch(err => {
    console.error("Error accessing media devices:", err);
    socket.emit("message", { username: "System", room, message: "Failed to access camera/microphone" });
  });
}

socket.on("offer", ({ offer, username: caller, video }) => {
  isVideoCall = video;
  window.pendingOffer = offer;
  window.caller = caller;

  document.getElementById("callerInfo").innerHTML = `
    <i class="fas fa-phone-alt"></i>
    Incoming ${video ? 'video' : 'voice'} call from <strong>${caller}</strong>
  `;
  incomingCall.style.display = "block";
});

function acceptCall() {
  incomingCall.style.display = "none";

  navigator.mediaDevices.getUserMedia({ audio: true, video: isVideoCall }).then(stream => {
    localStream = stream;
    if (isVideoCall) {
      localVideo.srcObject = stream;
    }

    peerConnection = new RTCPeerConnection(config);
    peerConnection.onicecandidate = e => {
      if (e.candidate) socket.emit("ice-candidate", { candidate: e.candidate, room });
    };
    peerConnection.ontrack = e => {
      remoteVideo.srcObject = e.streams[0];
    };
    stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
    peerConnection.setRemoteDescription(new RTCSessionDescription(window.pendingOffer));
    peerConnection.createAnswer().then(answer => {
      peerConnection.setLocalDescription(answer);
      socket.emit("answer", { answer, room });
    });

    videoArea.style.display = isVideoCall ? "block" : "none";
    callControls.style.display = "flex";
    cameraBtn.style.display = isVideoCall ? "flex" : "none";
    voiceCallBtn.disabled = true;
    videoCallBtn.disabled = true;
  }).catch(err => {
    console.error("Error accessing media devices:", err);
    rejectCall();
  });
}

function rejectCall() {
  incomingCall.style.display = "none";
  socket.emit("reject-call", { room });
  endCall(true);
}

socket.on("answer", ({ answer }) => {
  if (peerConnection) {
    peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
  }
});

socket.on("ice-candidate", ({ candidate }) => {
  if (peerConnection) {
    peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
  }
});

function toggleMute() {
  if (!localStream) return;
  isMuted = !isMuted;
  const audioTrack = localStream.getAudioTracks()[0];
  if (audioTrack) {
    audioTrack.enabled = !isMuted;
  }
  const micIcon = document.getElementById("micIcon");
  micIcon.className = `fas ${isMuted ? 'fa-microphone-slash' : 'fa-microphone'}`;
  muteBtn.className = `btn ${isMuted ? 'btn-destructive' : 'btn-glass'} btn-icon-sm`;
}

function toggleCamera() {
  if (!localStream || !isVideoCall) return;
  isCamOn = !isCamOn;
  const videoTrack = localStream.getVideoTracks()[0];
  if (videoTrack) {
    videoTrack.enabled = isCamOn;
  }
  const camIcon = document.getElementById("camIcon");
  camIcon.className = `fas ${isCamOn ? 'fa-video' : 'fa-video-slash'}`;
  cameraBtn.className = `btn ${isCamOn ? 'btn-glass' : 'btn-destructive'} btn-icon-sm`;
}

function endCall(isRejected = false) {
  if (peerConnection) {
    peerConnection.close();
    peerConnection = null;
  }
  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
    localStream = null;
  }

  remoteVideo.srcObject = null;
  localVideo.srcObject = null;
  videoArea.style.display = "none";
  callControls.style.display = "none";
  incomingCall.style.display = "none";

  // Reset state and button styles
  isMuted = false;
  isCamOn = true;
  document.getElementById("micIcon").className = "fas fa-microphone";
  muteBtn.className = "btn btn-glass btn-icon-sm";
  document.getElementById("camIcon").className = "fas fa-video";
  cameraBtn.className = "btn btn-glass btn-icon-sm";
  
  voiceCallBtn.disabled = false;
  videoCallBtn.disabled = false;
  
  if (!isRejected) {
    socket.emit("call-ended", { username, room });
  }
}

// Event listeners
voiceCallBtn.addEventListener("click", () => startCall(false));
videoCallBtn.addEventListener("click", () => startCall(true));
muteBtn.addEventListener("click", toggleMute);
cameraBtn.addEventListener("click", toggleCamera);
endCallBtn.addEventListener("click", () => endCall());
acceptCallBtn.addEventListener("click", acceptCall);
rejectCallBtn.addEventListener("click", rejectCall);

socket.on("call-ended", ({ username: callerName }) => {
  endCall(true);
  socket.emit("message", {
    username: "System",
    room,
    message: `Call ended by ${callerName}`
  });
});

socket.on("call-rejected", ({ username: callerName }) => {
  endCall(true);
  socket.emit("message", {
    username: "System",
    room,
    message: `Call was rejected by ${callerName}`
  });
});

// Security features (retained as per original code)
window.addEventListener("beforeunload", function (e) {
  e.preventDefault();
  e.returnValue = '';
});

document.addEventListener("contextmenu", e => e.preventDefault());

document.addEventListener("keydown", function (e) {
  const k = e.key.toLowerCase();
  if (
    e.key === "F12" ||
    (e.ctrlKey && e.shiftKey && ["i", "j", "c"].includes(k)) ||
    (e.ctrlKey && k === "u") ||
    (e.metaKey && k === "u")
  ) {
    e.preventDefault();
    e.stopPropagation();
  }
});

document.addEventListener("copy", function (e) {
  const sel = window.getSelection();
  const anchor = sel?.anchorNode;
  const isLink = anchor && anchor.parentElement?.classList.contains("shared-link");
  if (!isLink) {
    e.preventDefault();
  }
});
</script>
</body>
</html>
